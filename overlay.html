<!DOCTYPE html>
<html lang="en" class="theme-amethyst">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>__PAGE_TITLE__</title>
    <meta name="description" content="__PAGE_DESCRIPTION__">
    <link rel="icon" type="image/png" href="__PAGE_ICON__">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary-hue: 260; /* Amethyst */
            --color-primary: hsl(var(--color-primary-hue), 60%, 60%);
            --color-primary-glow: hsl(var(--color-primary-hue), 80%, 70%);
            --color-primary-focus: hsl(var(--color-primary-hue), 70%, 65%);
            --color-primary-bg: hsl(var(--color-primary-hue), 40%, 15%);
        }
        .theme-emerald { --color-primary-hue: 150; }
        .theme-amber { --color-primary-hue: 40; }
        .theme-ruby { --color-primary-hue: 350; }
        .theme-sapphire { --color-primary-hue: 210; }

        body { background-color: #111111; font-family: 'Inter', sans-serif; overflow: hidden; color: #a3a3a3; }
        .glowing-avatar { border-color: var(--color-primary); box-shadow: 0 0 15px 2px var(--color-primary-glow); }
        .glass-card { background: rgba(20, 20, 22, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .tab-button.active { color: var(--color-primary); border-color: var(--color-primary); }
        input:focus, select:focus { --tw-ring-color: var(--color-primary-focus) !important; }
        .form-checkbox:checked, .form-radio:checked { background-color: var(--color-primary); }
        input:checked + .slider { background-color: var(--color-primary); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #27272a; border-radius: 20px; }
        .settings-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(100%); }
        .settings-panel.open { transform: translateX(0); }
        .event-card { animation: slide-in-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slide-in-up { 0% { opacity: 0; transform: translateY(20px) scale(0.98); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .form-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(22px); }
        input:disabled, label:has(input:disabled) { opacity: 0.5; cursor: not-allowed !important; }
        .theme-selector span { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .theme-selector span:hover { transform: scale(1.1); }
        .theme-selector span.active { transform: scale(1.15); box-shadow: 0 0 10px 2px currentColor; }
        .gift-card-tier-1 { border-left: 3px solid #6b7280; }
        .gift-card-tier-2 { border-left: 3px solid #22c55e; }
        .gift-card-tier-3 { border-left: 3px solid #3b82f6; }
        .gift-card-tier-4 { border-left: 3px solid #a855f7; }
        .gift-card-tier-5 { border-left: 3px solid #f59e0b; box-shadow: 0 0 15px -2px #f59e0b; }
    </style>
</head>
<body class="h-screen bg-black">
    <div id="loading-view" class="flex flex-col h-full w-full items-center justify-center bg-zinc-900 p-8 text-center">
        <i class="fa-solid fa-spinner fa-spin fa-3x" style="color: var(--color-primary)"></i>
        <p id="loading-text" class="mt-4 text-xl font-semibold text-gray-300">Connecting...</p>
    </div>
    <div id="offline-view" class="hidden flex-col h-full w-full items-center justify-center bg-zinc-900 p-8 text-center">
        <div id="offline-profile-content" class="max-w-md w-full glass-card rounded-2xl p-6 shadow-2xl"></div>
    </div>
    <div id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-full max-w-2xl bg-zinc-900/80 backdrop-blur-xl border-l border-zinc-700 shadow-2xl z-50 flex flex-col">
        <div class="flex-shrink-0 p-6 flex justify-between items-center border-b border-zinc-800">
            <h2 class="text-2xl font-bold text-white">Settings</h2>
            <button id="close-settings-button" class="text-zinc-400 hover:text-white transition-colors"><i class="fa-solid fa-times fa-xl"></i></button>
        </div>
        <div id="settings-content" class="flex-grow overflow-y-auto custom-scrollbar p-6 space-y-6">
             <div class="p-4 rounded-lg bg-zinc-800/50 border border-zinc-700">
                <h3 class="text-lg font-semibold text-white mb-4">Appearance</h3>
                <div class="theme-selector flex items-center justify-around p-2 bg-zinc-900 rounded-lg">
                    <span data-theme="amethyst" class="w-8 h-8 rounded-full cursor-pointer bg-purple-500 border-2 border-transparent" style="--tw-shadow-color: #a855f7;"></span>
                    <span data-theme="emerald" class="w-8 h-8 rounded-full cursor-pointer bg-emerald-500 border-2 border-transparent" style="--tw-shadow-color: #34d399;"></span>
                    <span data-theme="amber" class="w-8 h-8 rounded-full cursor-pointer bg-amber-500 border-2 border-transparent" style="--tw-shadow-color: #f59e0b;"></span>
                    <span data-theme="ruby" class="w-8 h-8 rounded-full cursor-pointer bg-red-500 border-2 border-transparent" style="--tw-shadow-color: #ef4444;"></span>
                    <span data-theme="sapphire" class="w-8 h-8 rounded-full cursor-pointer bg-sky-500 border-2 border-transparent" style="--tw-shadow-color: #38bdf8;"></span>
                </div>
            </div>
            <div class="p-4 rounded-lg bg-zinc-800/50 border border-zinc-700">
                <h3 class="text-lg font-semibold text-white mb-3">Master TTS Control</h3>
                <div class="flex items-center justify-between p-4 rounded-lg bg-zinc-900">
                    <span class="font-semibold text-lg text-white">Enable Text-to-Speech</span>
                    <label class="form-switch"><input type="checkbox" id="tts-enabled-toggle"><span class="slider"></span></label>
                </div>
            </div>
            <div id="tts-config-container" class="space-y-6 transition-opacity duration-300">
                <div class="p-4 rounded-lg bg-zinc-800/50 border border-zinc-700">
                    <h3 class="text-lg font-semibold text-white mb-3">Credentials</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="tts-api-key" class="block text-sm font-medium text-gray-300 mb-2">ElevenLabs API Key</label>
                            <input type="password" id="tts-api-key" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2">
                        </div>
                        <div class="relative">
                            <label for="tts-voice-id" class="block text-sm font-medium text-gray-300 mb-2">Voice ID</label>
                            <input type="text" id="tts-voice-id" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 pr-10">
                            <button id="tts-test-voice" class="absolute right-2 top-9 text-zinc-400 hover:text-white"><i class="fa-solid fa-play"></i></button>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-zinc-800/50 border border-zinc-700">
                    <h3 class="text-lg font-semibold text-white mb-3">Event Configuration</h3>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700/80 transition-colors"><input type="checkbox" id="tts-announce-join" class="form-checkbox h-5 w-5 border-zinc-600"> <span class="text-gray-300">Announce Joins</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700/80 transition-colors"><input type="checkbox" id="tts-announce-follow" class="form-checkbox h-5 w-5 border-zinc-600"> <span class="text-gray-300">Announce Follows</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700/80 transition-colors"><input type="checkbox" id="tts-announce-share" class="form-checkbox h-5 w-5 border-zinc-600"> <span class="text-gray-300">Announce Shares</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700/80 transition-colors"><input type="checkbox" id="tts-announce-like" class="form-checkbox h-5 w-5 border-zinc-600"> <span class="text-gray-300">Announce Likes</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700/80 transition-colors"><input type="checkbox" id="tts-announce-comment" class="form-checkbox h-5 w-5 border-zinc-600"> <span class="text-gray-300">Announce Comments</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg cursor-pointer hover:bg-zinc-700/80 transition-colors"><input type="checkbox" id="tts-announce-gift" class="form-checkbox h-5 w-5 border-zinc-600"> <span class="text-gray-300">Announce Gifts</span></label>
                    </div>
                    <div class="mt-6 space-y-3">
                        <p class="text-sm text-zinc-400">Use placeholders: {user}, {comment}, {count}, {gift_name}</p>
                        <input type="text" id="tts-template-join" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 focus:outline-none focus:ring-2 transition-opacity" placeholder="Join Template">
                        <input type="text" id="tts-template-follow" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 focus:outline-none focus:ring-2 transition-opacity" placeholder="Follow Template">
                        <input type="text" id="tts-template-share" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 focus:outline-none focus:ring-2 transition-opacity" placeholder="Share Template">
                        <input type="text" id="tts-template-like" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 focus:outline-none focus:ring-2 transition-opacity" placeholder="Like Template">
                        <input type="text" id="tts-template-comment" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 focus:outline-none focus:ring-2 transition-opacity" placeholder="Comment Template">
                        <input type="text" id="tts-template-gift" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 focus:outline-none focus:ring-2 transition-opacity" placeholder="Gift Template">
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-zinc-800/50 border border-zinc-700">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-white">Live Status</h3>
                        <button id="tts-clear-queue" class="text-sm text-zinc-400 hover:text-white transition-colors">Clear Queue</button>
                    </div>
                    <div class="space-y-3 p-4 rounded-lg bg-zinc-900 text-sm">
                        <div>
                            <span class="font-medium text-zinc-400">Current Status:</span>
                            <p id="settings-tts-playing" class="italic min-h-[1.25rem]" style="color: var(--color-primary-glow);">Idle</p>
                        </div>
                        <div>
                            <span class="font-medium text-zinc-400">Message Queue (<span id="settings-tts-queue-count">0</span>):</span>
                            <div id="settings-tts-queue-list" class="mt-2 p-2 bg-black/20 rounded-md max-h-32 overflow-y-auto custom-scrollbar">
                                <p class="text-zinc-500 italic">Queue is empty.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="live-view" class="hidden flex-col h-full p-4 space-y-4">
        <div id="status-bar" class="flex-shrink-0 glass-card p-3 rounded-lg flex justify-between items-center">
            <p id="tracking-status" class="font-semibold text-gray-300"></p>
            <div class="flex items-center gap-4">
                <p id="connection-status" class="font-semibold text-sm"></p>
                <button id="settings-button" class="text-zinc-400 hover:text-white transition-colors"><i class="fa-solid fa-cog fa-lg"></i></button>
            </div>
        </div>
        <div class="grid grid-cols-4 grid-rows-2 flex-grow h-0 gap-4">
            <div class="col-span-2 row-span-2 flex flex-col glass-card rounded-lg p-3">
                <h2 class="text-lg font-bold text-gray-200 mb-2 border-b border-zinc-700 pb-2">Live Chat</h2>
                <div id="comment-container" class="flex-grow overflow-y-auto space-y-3 custom-scrollbar pr-2"></div>
            </div>
            <div class="col-span-2 row-span-1 flex flex-col glass-card rounded-lg p-3">
                <div class="flex border-b border-zinc-700 mb-2">
                    <button id="tab-profile" class="tab-button active py-2 px-4 text-sm font-semibold border-b-2 border-transparent">Profile</button>
                    <button id="tab-top-gifters" class="tab-button py-2 px-4 text-sm font-semibold border-b-2 border-transparent">Top Gifters</button>
                    <button id="tab-room" class="tab-button py-2 px-4 text-sm font-semibold border-b-2 border-transparent">Room Info</button>
                </div>
                <div class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                    <div id="content-profile" class="tab-content active text-sm text-gray-400 space-y-2"></div>
                    <div id="content-top-gifters" class="tab-content text-sm text-gray-400 space-y-2"><p class="text-center italic text-zinc-500 pt-4">No gifts received yet.</p></div>
                    <div id="content-room" class="tab-content"><pre class="text-xs text-gray-400">Awaiting Room Info...</pre></div>
                </div>
            </div>
            <div class="col-span-2 row-span-1 flex flex-col glass-card rounded-lg p-3">
                <h2 class="text-lg font-bold text-gray-200 mb-2 border-b border-zinc-700 pb-2">Activity Feed</h2>
                <div id="activity-container" class="flex-grow overflow-y-auto space-y-3 custom-scrollbar pr-2"></div>
            </div>
        </div>
    </div>
    <script>
        const ui = {
            views: { loading: document.getElementById('loading-view'), offline: document.getElementById('offline-view'), live: document.getElementById('live-view') },
            containers: { comment: document.getElementById('comment-container'), activity: document.getElementById('activity-container'), profile: document.getElementById('content-profile'), room: document.getElementById('content-room'), topGifters: document.getElementById('content-top-gifters'), offlineProfile: document.getElementById('offline-profile-content') },
            status: { tracking: document.getElementById('tracking-status'), connection: document.getElementById('connection-status'), loadingText: document.getElementById('loading-text') },
            tabs: { profile: document.getElementById('tab-profile'), room: document.getElementById('tab-room'), topGifters: document.getElementById('tab-top-gifters') },
            settings: {
                panel: document.getElementById('settings-panel'),
                content: document.getElementById('settings-content'),
                openBtn: document.getElementById('settings-button'),
                closeBtn: document.getElementById('close-settings-button'),
                apiKey: document.getElementById('tts-api-key'),
                voiceId: document.getElementById('tts-voice-id'),
                testVoiceBtn: document.getElementById('tts-test-voice'),
                clearQueueBtn: document.getElementById('tts-clear-queue'),
                enabled: document.getElementById('tts-enabled-toggle'),
                configContainer: document.getElementById('tts-config-container'),
                themeSelectors: document.querySelectorAll('.theme-selector span'),
                announce: { comment: document.getElementById('tts-announce-comment'), like: document.getElementById('tts-announce-like'), gift: document.getElementById('tts-announce-gift'), follow: document.getElementById('tts-announce-follow'), share: document.getElementById('tts-announce-share'), join: document.getElementById('tts-announce-join'), },
                templates: { comment: document.getElementById('tts-template-comment'), like: document.getElementById('tts-template-like'), gift: document.getElementById('tts-template-gift'), follow: document.getElementById('tts-template-follow'), share: document.getElementById('tts-template-share'), join: document.getElementById('tts-template-join'), },
                ttsStatus: { playing: document.getElementById('settings-tts-playing'), queueCount: document.getElementById('settings-tts-queue-count'), queueList: document.getElementById('settings-tts-queue-list') }
            }
        };

        let ttsQueue = [], isSpeaking = false, settings = {};
        let topGifters = {};
        const silentAudio = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';

        const defaultSettings = {
            theme: 'amethyst',
            tts: {
                apiKey: '', voiceId: '21m00Tcm4TlvDq8ikWAM', enabled: false,
                announce: { comment: true, like: false, gift: true, follow: true, share: false, join: false },
                templates: { comment: '{user} said: {comment}', like: '{user} sent {count} likes', gift: '{user} sent {count} {gift_name}', follow: '{user} followed', share: '{user} shared the stream', join: '{user} joined' }
            }
        };
        
        function saveAndApplySettings() {
            let currentTheme = 'amethyst';
            ui.settings.themeSelectors.forEach(s => { if(s.classList.contains('active')) currentTheme = s.dataset.theme; });
            settings.theme = currentTheme;
            settings.tts.apiKey = ui.settings.apiKey.value;
            settings.tts.voiceId = ui.settings.voiceId.value;
            settings.tts.enabled = ui.settings.enabled.checked;
            for (const event in settings.tts.announce) {
                settings.tts.announce[event] = ui.settings.announce[event].checked;
                settings.tts.templates[event] = ui.settings.templates[event].value;
            }
            localStorage.setItem('liveTrackerSettings', JSON.stringify(settings));
            applySettings();
        }

        function applySettings() {
            document.documentElement.className = `theme-${settings.theme}`;
            ui.settings.themeSelectors.forEach(selector => {
                selector.classList.toggle('active', selector.dataset.theme === settings.theme);
            });
            const isTTSEnabled = settings.tts.enabled;
            ui.settings.configContainer.style.opacity = isTTSEnabled ? '1' : '0.5';
            ui.settings.configContainer.style.pointerEvents = isTTSEnabled ? 'auto' : 'none';
            for (const event in ui.settings.announce) {
                ui.settings.templates[event].disabled = !ui.settings.announce[event].checked;
            }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('liveTrackerSettings');
            settings = savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings), tts: { ...defaultSettings.tts, ...(JSON.parse(savedSettings).tts || {}) } } : defaultSettings;
            ui.settings.apiKey.value = settings.tts.apiKey;
            ui.settings.voiceId.value = settings.tts.voiceId;
            ui.settings.enabled.checked = settings.tts.enabled;
            for (const event in settings.tts.announce) {
                if(ui.settings.announce[event]) ui.settings.announce[event].checked = settings.tts.announce[event];
                if(ui.settings.templates[event]) ui.settings.templates[event].value = settings.tts.templates[event];
            }
            applySettings();
        }

        function updateSettingsTTSStatusUI(statusText = null) {
            const statusEl = ui.settings.ttsStatus.playing;
            if (statusText) {
                statusEl.textContent = statusText;
                statusEl.classList.toggle('text-red-400', statusText.toLowerCase().includes('error') || statusText.toLowerCase().includes('blocked') || statusText.toLowerCase().includes('invalid'));
                statusEl.classList.remove('italic');
                statusEl.style.color = statusEl.classList.contains('text-red-400') ? '' : 'var(--color-primary-glow)';
            } else {
                statusEl.textContent = 'Idle';
                statusEl.className = 'italic min-h-[1.25rem]';
                statusEl.style.color = 'var(--color-primary-glow)';
            }
            ui.settings.ttsStatus.queueCount.textContent = ttsQueue.length;
            const queueList = ui.settings.ttsStatus.queueList;
            queueList.innerHTML = ttsQueue.length === 0 ? '<p class="text-zinc-500 italic">Queue is empty.</p>' : ttsQueue.map(text => `<p class="text-gray-300 truncate">${text}</p>`).join('');
        }

        async function playTTS(text, isTest = false) {
            if (!text || text.trim() === '') {
                if(!isTest) { isSpeaking = false; processTTSQueue(); }
                return;
            }
            if (!settings.tts.apiKey || !settings.tts.voiceId) {
                updateSettingsTTSStatusUI('API Error: Key or Voice ID missing.');
                if(!isTest) { isSpeaking = false; setTimeout(processTTSQueue, 3000); }
                return;
            }
            const url = `https://api.elevenlabs.io/v1/text-to-speech/${settings.tts.voiceId}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'xi-api-key': settings.tts.apiKey },
                    body: JSON.stringify({ text, model_id: "eleven_turbo_v2" })
                });
                if (!response.ok) {
                    let errorDetail = `API Error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorDetail = `API Error: ${errorData.detail?.message || JSON.stringify(errorData.detail)}`;
                    } catch (e) {}
                    throw new Error(errorDetail);
                }
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                if (!isTest) {
                    audio.onended = () => { isSpeaking = false; updateSettingsTTSStatusUI(); processTTSQueue(); };
                }
                await audio.play();
            } catch (error) {
                console.error("TTS Error:", error);
                updateSettingsTTSStatusUI(error.message);
                if (!isTest) { isSpeaking = false; setTimeout(processTTSQueue, 5000); }
            }
        }
        
        function processTTSQueue() {
            if (isSpeaking || ttsQueue.length === 0 || !settings.tts.enabled) return;
            isSpeaking = true;
            const text = ttsQueue.shift();
            updateSettingsTTSStatusUI(text);
            playTTS(text);
        }
        
        function addToTTSQueue(data, type) {
            if (!settings.tts.enabled || !settings.tts.announce[type]) return;
            if (type === 'comment' && (!data.comment || data.comment.trim() === '')) return;

            const template = settings.tts.templates[type];
            if (!template) return;
            const formattedText = template
                .replace(/{user}/g, data.user)
                .replace(/{comment}/g, data.comment)
                .replace(/{count}/g, data.count)
                .replace(/{gift_name}/g, data.gift_name);
            if (formattedText) {
                ttsQueue.push(formattedText);
                updateSettingsTTSStatusUI(isSpeaking ? ui.settings.ttsStatus.playing.textContent : null);
                processTTSQueue();
            }
        }

        function renderTopGifters() {
            const sortedGifters = Object.entries(topGifters).sort((a, b) => b[1].totalCoins - a[1].totalCoins);
            if(sortedGifters.length === 0) {
                ui.containers.topGifters.innerHTML = '<p class="text-center italic text-zinc-500 pt-4">No gifts received yet.</p>';
                return;
            }
            ui.containers.topGifters.innerHTML = sortedGifters.map(([userId, data], index) => `
                <div class="flex items-center space-x-4 p-2 rounded-lg bg-zinc-800/50">
                    <span class="font-bold text-lg w-6 text-center" style="color:var(--color-primary-glow)">#${index + 1}</span>
                    <img src="${data.avatar || 'https://p16-sign-va.tiktokcdn.com/tos-maliva-avt-0068/e9097a955776334553591427507d3999~c5_720x720.jpeg'}" class="w-10 h-10 rounded-full object-cover">
                    <div class="flex-grow">
                        <p class="font-semibold text-white">${data.user}</p>
                        <p class="text-xs text-zinc-400">${data.totalCoins.toLocaleString()} coins</p>
                    </div>
                </div>
            `).join('');
        }
        
        function addEvent(container, htmlContent) {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = htmlContent;
            const newEvent = wrapper.firstElementChild;
            if (newEvent) {
                container.appendChild(newEvent);
                if (container.children.length > 100) container.firstElementChild.remove();
                container.scrollTop = container.scrollHeight;
            }
        }

        function switchView(viewName) {
            Object.values(ui.views).forEach(key => key.style.display = 'none');
            ui.views[viewName].style.display = 'flex';
        }

        function processEvent(data) {
            let html, container, userHtml;
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            if (data.type !== 'system_status') {
                 addToTTSQueue(data, data.type);
            }

            switch (data.type) {
                case 'profile_info':
                    ui.containers.profile.innerHTML = `<div class="flex flex-col items-center space-y-4 pt-2">
                        <img src="${data.data.avatar}" class="w-24 h-24 rounded-full border-4 glowing-avatar object-cover">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-gray-100">${data.data.nickname || 'N/A'}</p>
                            <p class="text-gray-400">@${data.data.username || 'N/A'}</p>
                        </div></div>`;
                    ui.containers.offlineProfile.innerHTML = ui.containers.profile.innerHTML;
                    return;
                case 'status_update': switchView(data.status === 'live' ? 'live' : 'offline'); return;
                case 'room_info_update': ui.containers.room.innerHTML = `<pre class="text-xs text-gray-400 whitespace-pre-wrap break-all">${JSON.stringify(data.data, null, 2)}</pre>`; return;
                case 'comment':
                    container = ui.containers.comment;
                    html = `<div class="event-card"><div class="flex items-start space-x-3">
                        <img src="${data.avatar || 'https://p16-sign-va.tiktokcdn.com/tos-maliva-avt-0068/e9097a955776334553591427507d3999~c5_720x720.jpeg'}" class="w-8 h-8 rounded-full mt-1 object-cover">
                        <div class="flex-grow"><p class="text-sm"><span class="font-bold text-gray-200">${data.user || 'User'}:</span> <span class="text-gray-300">${data.comment}</span></p>
                        <p class="text-xs text-zinc-500">${time}</p></div></div></div>`;
                    break;
                case 'gift':
                    if (data.user && data.coins > 0) {
                        if (!topGifters[data.userId]) topGifters[data.userId] = { user: data.user, avatar: data.avatar, totalCoins: 0 };
                        topGifters[data.userId].totalCoins += data.coins * data.count;
                        renderTopGifters();
                    }
                    let giftTier = 'gift-card-tier-1';
                    if (data.coins >= 1000) giftTier = 'gift-card-tier-5';
                    else if (data.coins >= 500) giftTier = 'gift-card-tier-4';
                    else if (data.coins >= 100) giftTier = 'gift-card-tier-3';
                    else if (data.coins >= 10) giftTier = 'gift-card-tier-2';

                    container = ui.containers.activity;
                    html = `<div class="event-card"><div class="flex items-center space-x-3 p-2 rounded-lg bg-zinc-800/60 ${giftTier}">
                        <img src="${data.gift_image_url}" class="w-10 h-10">
                        <div class="flex-grow"><p class="text-sm text-white">${data.user} sent ${data.count}x <b>${data.gift_name}</b>!</p>
                        <p class="text-xs text-zinc-400">${(data.coins * data.count).toLocaleString()} coins â€¢ ${time}</p></div></div></div>`;
                    break;
                case 'like': case 'follow': case 'share': case 'join':
                    const iconMap = { like: 'fa-heart text-red-500', follow: 'fa-user-plus text-sky-400', share: 'fa-share text-purple-400', join: 'fa-right-to-bracket text-gray-400' };
                    const textMap = { like: `sent ${data.count} like(s)!`, follow: 'followed!', share: 'shared!', join: 'joined!' };
                    container = ui.containers.activity;
                    html = `<div class="event-card"><div class="flex items-center space-x-3 text-sm p-1.5"><i class="fa-solid ${iconMap[data.type]} w-4 text-center"></i>
                        <p class="text-zinc-300"><span class="font-semibold text-white">${data.user}</span> ${textMap[data.type]}</p>
                        <p class="text-xs text-zinc-500 ml-auto">${time}</p></div></div>`;
                    break;
                case 'system_status': ui.status.connection.innerHTML = `<span>${data.status}</span>`; return;
                default: return;
            }
            if (container) addEvent(container, html);
        }
        
        function setupEventListeners() {
            ui.settings.openBtn.addEventListener('click', () => {
                new Audio(silentAudio).play().catch(e => {});
                ui.settings.panel.classList.add('open');
            });
            ui.settings.closeBtn.addEventListener('click', () => ui.settings.panel.classList.remove('open'));
            ui.settings.testVoiceBtn.addEventListener('click', () => playTTS('Hello, this is a test of my voice.', true));
            ui.settings.clearQueueBtn.addEventListener('click', () => {
                ttsQueue.length = 0;
                updateSettingsTTSStatusUI();
            });

            const allSettingsInputs = ui.settings.content.querySelectorAll('input, select');
            allSettingsInputs.forEach(input => {
                input.addEventListener(input.type === 'checkbox' ? 'change' : 'input', saveAndApplySettings);
            });
            
            ui.settings.themeSelectors.forEach(selector => {
                selector.addEventListener('click', () => {
                    ui.settings.themeSelectors.forEach(s => s.classList.remove('active'));
                    selector.classList.add('active');
                    saveAndApplySettings();
                });
            });

            Object.values(ui.tabs).forEach(tab => {
                tab.addEventListener('click', () => {
                    Object.values(ui.tabs).forEach(t => t.classList.remove('active'));
                    Object.values(ui.containers).forEach(c => c.classList?.remove('active'));
                    tab.classList.add('active');
                    const contentId = `content-${tab.id.split('-')[1]}`;
                    document.getElementById(contentId)?.classList.add('active');
                });
            });
        }

        function connect() {
            const username = window.location.pathname.split('/').filter(p => p)[0];
            if (!username) {
                switchView('offline');
                document.title = 'Error | TikTok Live Tracker';
                ui.containers.offlineProfile.innerHTML = `<h1 class="text-2xl text-red-400 font-bold">Error: No Username Provided</h1>`;
                return;
            }
            switchView('loading');
            ui.status.tracking.innerHTML = `Tracking: <span class="font-bold text-white text-lg">${username}</span>`;
            
            const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`${protocol}://${location.host}/ws/${username}`);
            
            ws.onmessage = (event) => {
                try { processEvent(JSON.parse(event.data)); } catch (e) { console.error("Message Parse Error:", e, event.data); }
            };
            ws.onclose = () => setTimeout(connect, 5000);
            ws.onerror = (e) => ws.close();
        }
        
        loadSettings();
        setupEventListeners();
        connect();
    </script>
</body>
</html>
