<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>__PAGE_TITLE__</title>
    <meta name="description" content="__PAGE_DESCRIPTION__">
    <link rel="icon" type="image/png" href="__PAGE_ICON__">
    <meta property="og:type" content="website">
    <meta property="og:title" content="__PAGE_TITLE__">
    <meta property="og:description" content="__PAGE_DESCRIPTION__">
    <meta property="og:image" content="__PAGE_ICON__">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="__PAGE_TITLE__">
    <meta name="twitter:description" content="__PAGE_DESCRIPTION__">
    <meta name="twitter:image" content="__PAGE_ICON__">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #111111; font-family: 'Inter', sans-serif; overflow: hidden; color: #a3a3a3; }
        .event-card { transform-origin: bottom; animation: slide-in-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes slide-in-up { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #27272a; border-radius: 20px; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #3f3f46; color: #fafafa; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .fa-circle, .fa-circle-xmark, .fa-triangle-exclamation, .fa-bug, .fa-pause-circle, .fa-play-circle, .fa-magnifying-glass { font-size: 0.7rem; vertical-align: middle; }
        .blinking-dot { animation: blink 1.5s infinite ease-in-out; display: inline-block; width: 0.75rem; height: 0.75rem; border-radius: 9999px; background-color: currentColor; margin-right: 0.75rem; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .glass-card { background: rgba(39, 39, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glowing-avatar { box-shadow: 0 0 15px rgba(52, 152, 219, 0.7); }
        .activity-filter-dropdown { display: none; position: absolute; right: 0; top: 100%; z-index: 10; }
        .settings-panel { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .settings-panel.hidden { opacity: 0; visibility: hidden; }
        .form-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body class="h-screen">
    <div id="loading-view" class="flex flex-col h-full w-full items-center justify-center bg-zinc-900 p-8 text-center">
        <i class="fa-solid fa-spinner fa-spin fa-3x text-sky-400"></i>
        <p id="loading-text" class="mt-4 text-xl font-semibold text-gray-300">Connecting...</p>
    </div>

    <div id="offline-view" class="hidden flex-col h-full w-full items-center justify-center bg-zinc-900 p-8 text-center">
        <div id="offline-profile-content" class="max-w-md w-full glass-card rounded-2xl p-6 shadow-2xl"></div>
    </div>
    
    <div id="settings-panel" class="settings-panel hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center">
        <div class="bg-zinc-900 border border-zinc-700 rounded-2xl shadow-xl w-full max-w-2xl p-6 relative max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-white mb-4">TTS Settings</h2>
            <button id="close-settings-button" class="absolute top-4 right-4 text-zinc-400 hover:text-white transition-colors">
                <i class="fa-solid fa-times fa-lg"></i>
            </button>
            <div class="flex-grow overflow-y-auto custom-scrollbar pr-4 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tts-api-key" class="block text-sm font-medium text-gray-300 mb-2">ElevenLabs API Key</label>
                        <input type="password" id="tts-api-key" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="tts-voice-id" class="block text-sm font-medium text-gray-300 mb-2">Voice ID</label>
                        <input type="text" id="tts-voice-id" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                </div>

                <div class="flex items-center justify-between p-4 rounded-lg bg-zinc-800">
                    <span class="font-semibold text-lg text-white">Enable TTS</span>
                    <label class="form-switch"><input type="checkbox" id="tts-enabled-toggle"><span class="slider"></span></label>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">TTS Status</h3>
                    <div class="space-y-3 p-4 rounded-lg bg-zinc-800 text-sm">
                        <div>
                            <span class="font-medium text-zinc-400">Now Playing:</span>
                            <p id="settings-tts-playing" class="text-sky-300 italic min-h-[1.25rem]">None</p>
                        </div>
                         <div>
                            <span class="font-medium text-zinc-400">Queue (<span id="settings-tts-queue-count">0</span>/20):</span>
                            <div id="settings-tts-queue-list" class="mt-2 p-2 bg-zinc-900 rounded-md max-h-32 overflow-y-auto custom-scrollbar">
                                <p class="text-zinc-500 italic">Queue is empty.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Announce Events</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg"><input type="checkbox" id="tts-announce-comment" class="form-checkbox h-5 w-5 rounded bg-zinc-700 border-zinc-600 text-sky-500 focus:ring-sky-500"> <span class="text-gray-300">Comments</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg"><input type="checkbox" id="tts-announce-like" class="form-checkbox h-5 w-5 rounded bg-zinc-700 border-zinc-600 text-sky-500 focus:ring-sky-500"> <span class="text-gray-300">Likes</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg"><input type="checkbox" id="tts-announce-gift" class="form-checkbox h-5 w-5 rounded bg-zinc-700 border-zinc-600 text-sky-500 focus:ring-sky-500"> <span class="text-gray-300">Gifts</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg"><input type="checkbox" id="tts-announce-follow" class="form-checkbox h-5 w-5 rounded bg-zinc-700 border-zinc-600 text-sky-500 focus:ring-sky-500"> <span class="text-gray-300">Follows</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg"><input type="checkbox" id="tts-announce-share" class="form-checkbox h-5 w-5 rounded bg-zinc-700 border-zinc-600 text-sky-500 focus:ring-sky-500"> <span class="text-gray-300">Shares</span></label>
                        <label class="flex items-center space-x-3 bg-zinc-800 p-3 rounded-lg"><input type="checkbox" id="tts-announce-join" class="form-checkbox h-5 w-5 rounded bg-zinc-700 border-zinc-600 text-sky-500 focus:ring-sky-500"> <span class="text-gray-300">Joins</span></label>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Announcement Templates</h3>
                    <div class="space-y-2 text-sm">
                        <p class="text-xs text-zinc-400">Use placeholders: {user}, {comment}, {count}, {gift_name}</p>
                        <input type="text" id="tts-template-comment" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2" placeholder="Comment Template">
                        <input type="text" id="tts-template-like" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2" placeholder="Like Template">
                        <input type="text" id="tts-template-gift" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2" placeholder="Gift Template">
                        <input type="text" id="tts-template-follow" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2" placeholder="Follow Template">
                        <input type="text" id="tts-template-share" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2" placeholder="Share Template">
                        <input type="text" id="tts-template-join" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2" placeholder="Join Template">
                    </div>
                </div>
            </div>
             <div class="mt-6 flex-shrink-0">
                <button id="save-settings-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Save & Close</button>
            </div>
        </div>
    </div>

    <div id="live-view" class="hidden flex-col h-full p-4 space-y-4">
        <div id="status-bar" class="flex-shrink-0 glass-card p-3 rounded-lg flex justify-between items-center">
            <p id="tracking-status" class="font-semibold text-gray-300"></p>
            <div class="flex items-center gap-4">
                <p id="connection-status" class="font-semibold text-sm"></p>
                <button id="settings-button" class="text-zinc-400 hover:text-white transition-colors"><i class="fa-solid fa-cog fa-lg"></i></button>
            </div>
        </div>
        <div class="grid grid-cols-4 grid-rows-2 flex-grow h-0 gap-4">
            <div class="col-span-2 row-span-2 flex flex-col glass-card rounded-lg p-3">
                <h2 class="text-lg font-bold text-gray-200 mb-2 border-b border-zinc-700 pb-2">Live Chat</h2>
                <div class="flex items-center space-x-2 mb-2 flex-shrink-0">
                    <input type="text" id="chat-search-input" class="bg-zinc-800 text-gray-300 text-sm rounded-md w-full px-3 py-1.5 border border-transparent focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Search by message...">
                    <button id="chat-filter-button" class="bg-zinc-700 hover:bg-zinc-600 text-gray-200 w-12 h-9 flex-shrink-0 flex items-center justify-center rounded-md transition-colors">
                        <i id="chat-filter-icon" class="fa-solid fa-message"></i>
                    </button>
                </div>
                <div id="comment-container" class="flex-grow overflow-y-auto space-y-2 custom-scrollbar pr-2"></div>
            </div>
            <div class="col-span-2 row-span-1 flex flex-col glass-card rounded-lg p-3">
                <div class="flex border-b border-zinc-700 mb-2">
                    <button id="tab-profile" class="tab-button active py-2 px-4 text-sm font-semibold rounded-t-md">Profile</button>
                    <button id="tab-room" class="tab-button py-2 px-4 text-sm font-semibold rounded-t-md">Room Info</button>
                    <button id="tab-gift" class="tab-button py-2 px-4 text-sm font-semibold rounded-t-md">Gift Info</button>
                </div>
                <div class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                    <div id="content-profile" class="tab-content active text-sm text-gray-400 space-y-2"></div>
                    <div id="content-room" class="tab-content"><pre class="text-xs text-gray-400">Awaiting Room Info...</pre></div>
                    <div id="content-gift" class="tab-content"><pre class="text-xs text-gray-400">Awaiting Gift Info...</pre></div>
                </div>
            </div>
            <div class="col-span-1 row-span-1 flex flex-col glass-card rounded-lg p-3">
                <div class="flex justify-between items-center text-lg font-bold text-gray-200 mb-2 border-b border-zinc-700 pb-2">
                    <h2>Likes</h2>
                    <p class="text-2xl font-bold text-white"><span id="total-likes-count">0</span></p>
                </div>
                <div id="like-container" class="flex-grow overflow-y-auto space-y-2 custom-scrollbar pr-2"></div>
            </div>
            <div class="col-span-1 row-span-1 flex flex-col glass-card rounded-lg p-3">
                <div class="flex justify-between items-center text-lg font-bold text-gray-200 mb-2 border-b border-zinc-700 pb-2">
                    <h2>Activity Feed</h2>
                    <div class="relative">
                        <button id="activity-filter-button" class="bg-zinc-700 hover:bg-zinc-600 text-gray-200 w-9 h-9 flex items-center justify-center rounded-md transition-colors">
                            <i class="fa-solid fa-filter"></i>
                        </button>
                        <div id="activity-filter-dropdown" class="activity-filter-dropdown mt-2 w-48 bg-zinc-800 rounded-md shadow-lg">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700" data-filter="all"><i class="fa-solid fa-asterisk w-4 text-center mr-2"></i>All</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700" data-filter="follow"><i class="fa-solid fa-user-plus w-4 text-center mr-2"></i>Follows</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700" data-filter="share"><i class="fa-solid fa-share w-4 text-center mr-2"></i>Shares</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700" data-filter="join"><i class="fa-solid fa-right-to-bracket w-4 text-center mr-2"></i>Joins</a>
                             <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700" data-filter="gift"><i class="fa-solid fa-gift w-4 text-center mr-2"></i>Gifts</a>
                        </div>
                    </div>
                </div>
                <div id="activity-container" class="flex-grow overflow-y-auto space-y-2 custom-scrollbar pr-2"></div>
            </div>
        </div>
    </div>

    <script>
        const ui = {
            views: { loading: document.getElementById('loading-view'), offline: document.getElementById('offline-view'), live: document.getElementById('live-view') },
            containers: { like: document.getElementById('like-container'), comment: document.getElementById('comment-container'), activity: document.getElementById('activity-container'), profile: document.getElementById('content-profile'), room: document.getElementById('content-room'), gift: document.getElementById('content-gift'), offlineProfile: document.getElementById('offline-profile-content') },
            status: { tracking: document.getElementById('tracking-status'), connection: document.getElementById('connection-status'), loadingText: document.getElementById('loading-text') },
            tabs: { profile: document.getElementById('tab-profile'), room: document.getElementById('tab-room'), gift: document.getElementById('tab-gift') },
            chat: { input: document.getElementById('chat-search-input'), filterButton: document.getElementById('chat-filter-button'), filterIcon: document.getElementById('chat-filter-icon') },
            activity: { filterButton: document.getElementById('activity-filter-button'), filterDropdown: document.getElementById('activity-filter-dropdown') },
            totalLikesCount: document.getElementById('total-likes-count'),
            settings: {
                panel: document.getElementById('settings-panel'),
                openBtn: document.getElementById('settings-button'),
                closeBtn: document.getElementById('close-settings-button'),
                saveBtn: document.getElementById('save-settings-button'),
                apiKey: document.getElementById('tts-api-key'),
                voiceId: document.getElementById('tts-voice-id'),
                enabled: document.getElementById('tts-enabled-toggle'),
                announce: {
                    comment: document.getElementById('tts-announce-comment'),
                    like: document.getElementById('tts-announce-like'),
                    gift: document.getElementById('tts-announce-gift'),
                    follow: document.getElementById('tts-announce-follow'),
                    share: document.getElementById('tts-announce-share'),
                    join: document.getElementById('tts-announce-join'),
                },
                templates: {
                    comment: document.getElementById('tts-template-comment'),
                    like: document.getElementById('tts-template-like'),
                    gift: document.getElementById('tts-template-gift'),
                    follow: document.getElementById('tts-template-follow'),
                    share: document.getElementById('tts-template-share'),
                    join: document.getElementById('tts-template-join'),
                },
                ttsStatus: {
                    playing: document.getElementById('settings-tts-playing'),
                    queueCount: document.getElementById('settings-tts-queue-count'),
                    queueList: document.getElementById('settings-tts-queue-list')
                }
            }
        };

        let chatFilterMode = 'message', activityFilterMode = 'all', currentTotalLikes = 0, animationFrameId, keepAliveInterval;
        let ttsQueue = [], isSpeaking = false, ttsSettings = {};
        const MAX_TTS_QUEUE_LENGTH = 20;

        const defaultTTSSettings = {
            apiKey: '',
            voiceId: '21m00Tcm4TlvDq8ikWAM',
            enabled: false,
            announce: { comment: true, like: false, gift: true, follow: true, share: false, join: false },
            templates: {
                comment: '{user} said: {comment}',
                like: '{user} sent {count} likes',
                gift: '{user} sent {count} {gift_name}',
                follow: '{user} followed',
                share: '{user} shared the stream',
                join: '{user} joined'
            }
        };

        const statusIcons = {
            live: '<i class="fa-solid fa-circle text-green-500 mr-2"></i>',
            offline: '<i class="fa-solid fa-circle text-gray-500 mr-2"></i>',
            ended: '<i class="fa-solid fa-circle-xmark text-red-500 mr-2"></i>',
            disconnected: '<i class="fa-solid fa-triangle-exclamation text-yellow-400 mr-2"></i>',
            error: '<i class="fa-solid fa-bug text-red-500 mr-2"></i>',
            warn: '<i class="fa-solid fa-triangle-exclamation text-yellow-400 mr-2"></i>',
            info: '<i class="fa-solid fa-magnifying-glass text-sky-400 mr-2"></i>'
        };

        function loadSettings() {
            const savedSettings = localStorage.getItem('ttsSettings');
            ttsSettings = savedSettings ? { ...defaultTTSSettings, ...JSON.parse(savedSettings) } : defaultTTSSettings;
            ui.settings.apiKey.value = ttsSettings.apiKey;
            ui.settings.voiceId.value = ttsSettings.voiceId;
            ui.settings.enabled.checked = ttsSettings.enabled;
            for (const event in ttsSettings.announce) {
                ui.settings.announce[event].checked = ttsSettings.announce[event];
                ui.settings.templates[event].value = ttsSettings.templates[event];
            }
        }

        function saveSettings() {
            ttsSettings.apiKey = ui.settings.apiKey.value;
            ttsSettings.voiceId = ui.settings.voiceId.value;
            ttsSettings.enabled = ui.settings.enabled.checked;
            for (const event in ttsSettings.announce) {
                ttsSettings.announce[event] = ui.settings.announce[event].checked;
                ttsSettings.templates[event] = ui.settings.templates[event].value;
            }
            localStorage.setItem('ttsSettings', JSON.stringify(ttsSettings));
            ui.settings.panel.classList.add('hidden');
        }
        
        function updateSettingsTTSStatusUI(playingText = null) {
            ui.settings.ttsStatus.playing.textContent = playingText || (isSpeaking ? ui.settings.ttsStatus.playing.textContent : 'None');
            ui.settings.ttsStatus.playing.classList.toggle('italic', !playingText && !isSpeaking);
            
            ui.settings.ttsStatus.queueCount.textContent = ttsQueue.length;
            const queueList = ui.settings.ttsStatus.queueList;
            queueList.innerHTML = '';
            if (ttsQueue.length === 0) {
                queueList.innerHTML = '<p class="text-zinc-500 italic">Queue is empty.</p>';
            } else {
                ttsQueue.forEach(text => {
                    const p = document.createElement('p');
                    p.textContent = text;
                    p.className = 'text-gray-300 truncate';
                    queueList.appendChild(p);
                });
            }
        }

        async function playTTS(text) {
            if (!ttsSettings.apiKey || !ttsSettings.voiceId) {
                console.error("TTS Error: API Key or Voice ID is missing.");
                isSpeaking = false;
                updateSettingsTTSStatusUI();
                processTTSQueue();
                return;
            }
            const url = `https://api.elevenlabs.io/v1/text-to-speech/${ttsSettings.voiceId}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'xi-api-key': ttsSettings.apiKey },
                    body: JSON.stringify({ text, model_id: "eleven_multilingual_v2", voice_settings: { stability: 0.5, similarity_boost: 0.8 } })
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
                audio.onended = () => {
                    isSpeaking = false;
                    updateSettingsTTSStatusUI();
                    processTTSQueue();
                };
            } catch (error) {
                console.error("Failed to play TTS:", error);
                isSpeaking = false;
                updateSettingsTTSStatusUI();
                processTTSQueue();
            }
        }
        
        function processTTSQueue() {
            if (isSpeaking || ttsQueue.length === 0) return;
            isSpeaking = true;
            const text = ttsQueue.shift();
            updateSettingsTTSStatusUI(text);
            playTTS(text);
        }
        
        function addToTTSQueue(data, type) {
            if (!ttsSettings.enabled || !ttsSettings.announce[type]) return;
            
            const template = ttsSettings.templates[type];
            if (!template) return;
            
            const formattedText = template
                .replace('{user}', data.user || '')
                .replace('{comment}', data.comment || '')
                .replace('{count}', data.count || '')
                .replace('{gift_name}', data.gift_name || '');

            if (formattedText) {
                if (ttsQueue.length >= MAX_TTS_QUEUE_LENGTH) {
                    ttsQueue.shift();
                }
                ttsQueue.push(formattedText);
                updateSettingsTTSStatusUI();
                processTTSQueue();
            }
        }
        
        function switchView(viewName) {
            Object.keys(ui.views).forEach(key => ui.views[key].style.display = 'none');
            ui.views[viewName].style.display = 'flex';
        }

        function animateCount(targetValue) {
            const endValue = Number(String(targetValue).replace(/[^\d]/g, ''));
            const startValue = currentTotalLikes;
            if (isNaN(endValue) || startValue === endValue) {
                if (!isNaN(endValue)) ui.totalLikesCount.textContent = endValue.toLocaleString();
                return;
            };
            const duration = 500;
            let startTime = null;
            const step = timestamp => {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const current = Math.floor(progress * (endValue - startValue) + startValue);
                ui.totalLikesCount.textContent = current.toLocaleString();
                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(step);
                } else {
                    currentTotalLikes = endValue;
                    ui.totalLikesCount.textContent = endValue.toLocaleString();
                }
            };
            cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(step);
        }

        function addEvent(container, htmlContent, isComment = false) {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = htmlContent;
            const newEvent = wrapper.firstElementChild;
            if (newEvent) {
                newEvent.classList.add('event-card');
                container.appendChild(newEvent);
                container.scrollTop = container.scrollHeight;
                isComment ? filterChat() : filterActivity();
            }
        }

        function renderProfile(p) {
            const defaultAvatar = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            const avatar = p.avatar || defaultAvatar;
            const profileCard = `
                <div class="pt-16 w-full">
                    <div class="flex flex-col items-center space-y-4">
                        <img src="${avatar}" onerror="this.onerror=null;this.src='${defaultAvatar}';" class="w-24 h-24 rounded-full border-4 border-zinc-700 -mt-12 bg-zinc-900 object-cover glowing-avatar">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-gray-100">${p.nickname || 'N/A'}</p>
                            <p class="text-gray-400">@${p.username || 'N/A'}</p>
                        </div>
                        <div class="w-full glass-card rounded-lg p-4">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div><p class="font-bold text-gray-200 text-lg">${p.followers ? Number(p.followers).toLocaleString() : '0'}</p><p class="text-sm">Followers</p></div>
                                <div><p class="font-bold text-gray-200 text-lg">${p.following ? Number(p.following).toLocaleString() : '0'}</p><p class="text-sm">Following</p></div>
                            </div>
                        </div>
                        <div class="w-full text-left glass-card rounded-lg p-4">
                            <p class="font-bold text-gray-300">Bio:</p>
                            <p class="p-2 bg-zinc-900/50 rounded-md max-h-24 overflow-y-auto custom-scrollbar">${p.bio || 'This user has not provided a bio.'}</p>
                        </div>
                    </div>
                </div>`;
            ui.containers.profile.innerHTML = profileCard;
            ui.containers.offlineProfile.innerHTML = profileCard;
        }

        function processEvent(data) {
            let html, container, isComment = false, user = `<span class="font-semibold text-gray-400">${data.user || 'Someone'}</span>`;
            if (data.type !== 'system_status') {
                addToTTSQueue(data, data.type);
            }
            switch (data.type) {
                case 'profile_info': renderProfile(data.data); return;
                case 'status_update':
                    switchView(data.status === 'live' ? 'live' : 'offline');
                    if (data.status === 'offline') {
                        const offlineContainer = ui.containers.offlineProfile;
                        const existingStatus = offlineContainer.querySelector('.status-message');
                        if (existingStatus) existingStatus.remove();
                        const statusMessage = `<p class="mt-6 text-xl font-bold text-red-400 status-message flex items-center justify-center"><span class="blinking-dot text-red-400"></span> User is not live.</p>`;
                        offlineContainer.insertAdjacentHTML('beforeend', statusMessage);
                    }
                    return;
                case 'room_info_update': ui.containers.room.innerHTML = `<pre class="text-xs text-gray-400 whitespace-pre-wrap break-all">${JSON.stringify(data.data, null, 2)}</pre>`; return;
                case 'gift_info_update': ui.containers.gift.innerHTML = `<pre class="text-xs text-gray-400 whitespace-pre-wrap break-all">${JSON.stringify(data.data, null, 2)}</pre>`; return;
                case 'total_likes_update': animateCount(data.count); return;
                case 'like':
                    container = ui.containers.like;
                    html = `<div class="bg-zinc-800/50 p-2 rounded-md"><p class="font-medium text-xs"><i class="fa-solid fa-heart text-red-500 w-4 text-center"></i> ${user} sent ${data.count} like(s)!</p></div>`;
                    break;
                case 'comment':
                    container = ui.containers.comment; isComment = true;
                    html = `<div class="bg-zinc-800/50 p-2 rounded-md" data-user="${data.user || ''}" data-comment="${data.comment || ''}"><p class="text-sm"><span class="font-bold text-gray-200">${data.user || 'User'}:</span> <span class="text-gray-400">${data.comment}</span></p></div>`;
                    break;
                case 'follow': container = ui.containers.activity; html = `<div class="bg-zinc-800/50 p-2 rounded-md" data-event-type="follow"><p class="text-xs"><i class="fa-solid fa-user-plus text-sky-400 w-4 text-center"></i> ${user} followed!</p></div>`; break;
                case 'share': container = ui.containers.activity; html = `<div class="bg-zinc-800/50 p-2 rounded-md" data-event-type="share"><p class="text-xs"><i class="fa-solid fa-share text-purple-400 w-4 text-center"></i> ${user} shared!</p></div>`; break;
                case 'join': container = ui.containers.activity; html = `<div class="bg-zinc-800/50 p-2 rounded-md" data-event-type="join"><p class="text-xs"><i class="fa-solid fa-right-to-bracket text-gray-400 w-4 text-center"></i> ${user} joined!</p></div>`; break;
                case 'gift': container = ui.containers.activity; html = `<div class="bg-zinc-800/50 p-2 rounded-md" data-event-type="gift"><p class="text-xs"><i class="fa-solid fa-gift text-orange-400 w-4 text-center"></i> ${user} sent ${data.count}x ${data.gift_name}!</p></div>`; break;
                case 'system_status': ui.status.connection.innerHTML = `<span>${statusIcons[data.level] || ''}${data.status}</span>`; return;
                default: return;
            }
            if (container) addEvent(container, html, isComment);
        }

        function filterChat() {
            const query = ui.chat.input.value.toLowerCase();
            const comments = ui.containers.comment.querySelectorAll('div[data-comment]');
            comments.forEach(comment => {
                const user = comment.dataset.user.toLowerCase();
                const message = comment.dataset.comment.toLowerCase();
                const isVisible = chatFilterMode === 'message' ? message.includes(query) : user.includes(query);
                comment.style.display = isVisible ? 'block' : 'none';
            });
        }

        function filterActivity() {
            const events = ui.containers.activity.querySelectorAll('div[data-event-type]');
            events.forEach(event => {
                const isVisible = activityFilterMode === 'all' || activityFilterMode === event.dataset.eventType;
                event.style.display = isVisible ? 'block' : 'none';
            });
        }
        
        function setupEventListeners() {
            ui.chat.input.addEventListener('input', filterChat);
            ui.chat.filterButton.addEventListener('click', () => {
                chatFilterMode = (chatFilterMode === 'message') ? 'user' : 'message';
                ui.chat.filterIcon.className = `fa-solid fa-${chatFilterMode === 'message' ? 'message' : 'user'}`;
                ui.chat.input.placeholder = `Search by ${chatFilterMode}...`;
                filterChat();
            });
            ui.activity.filterButton.addEventListener('click', () => {
                ui.activity.filterDropdown.style.display = ui.activity.filterDropdown.style.display === 'block' ? 'none' : 'block';
            });
            ui.activity.filterDropdown.addEventListener('click', (e) => {
                e.preventDefault();
                const filter = e.target.closest('a').dataset.filter;
                if (filter) {
                    activityFilterMode = filter;
                    filterActivity();
                    ui.activity.filterDropdown.style.display = 'none';
                }
            });
            Object.keys(ui.tabs).forEach(key => {
                ui.tabs[key].addEventListener('click', () => {
                    Object.values(ui.tabs).forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    ui.tabs[key].classList.add('active');
                    document.getElementById(`content-${key}`).classList.add('active');
                });
            });
            ui.settings.openBtn.addEventListener('click', () => ui.settings.panel.classList.remove('hidden'));
            ui.settings.closeBtn.addEventListener('click', () => ui.settings.panel.classList.add('hidden'));
            ui.settings.saveBtn.addEventListener('click', saveSettings);
        }

        function resetUI() {
            Object.values(ui.containers).forEach(c => { if (c) c.innerHTML = ''; });
            ['room', 'gift'].forEach(key => ui.containers[key].innerHTML = '<pre class="text-xs text-gray-400">Awaiting Info...</pre>');
            ui.containers.profile.innerHTML = '<p class="text-center italic text-gray-500 pt-4">Awaiting data...</p>';
            ui.totalLikesCount.textContent = '0';
            currentTotalLikes = 0;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
        }

        function connect() {
            const username = window.location.pathname.split('/').filter(p => p)[0];
            if (!username) {
                switchView('offline');
                document.title = 'Error | TikTok API Tracker';
                ui.containers.offlineProfile.innerHTML = `<h1 class="text-2xl text-red-400 font-bold">Error: No Username Provided</h1><p class="text-gray-300 mt-2">Please navigate to the correct URL, for example: <span class="font-mono bg-zinc-700 p-1 rounded">/your_username</span></p>`;
                return;
            }
            resetUI();
            switchView('loading');
            ui.status.tracking.innerHTML = `Tracking: <span class="font-bold text-white text-lg">${username}</span>`;
            ui.status.loadingText.textContent = `Looking for @${username}...`;
            const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`${protocol}://${location.host}/ws/${username}`);
            ws.onopen = () => {
                ui.status.connection.innerHTML = `<span class="text-yellow-400"><i class="fa-solid fa-plug-circle-check mr-2"></i>Socket Opened</span>`;
                if (keepAliveInterval) clearInterval(keepAliveInterval);
                keepAliveInterval = setInterval(() => { if (ws.readyState === WebSocket.OPEN) ws.send('ping'); }, 30000);
            };
            ws.onmessage = (event) => {
                try { processEvent(JSON.parse(event.data)); } catch (e) { console.error("Message Parse Error:", e, event.data); }
            };
            ws.onclose = () => {
                clearInterval(keepAliveInterval);
                ui.status.connection.innerHTML = `<span class="text-red-500"><i class="fa-solid fa-xmark mr-2"></i>Disconnected. Retrying...</span>`;
                setTimeout(connect, 5000);
            };
            ws.onerror = (e) => {
                console.error("WebSocket Error:", e);
                ui.status.connection.innerHTML = `<span class="text-red-500"><i class="fa-solid fa-bug mr-2"></i>Connection Error</span>`;
                ws.close();
            };
        }
        
        loadSettings();
        setupEventListeners();
        connect();
    </script>
</body>
</html>
