<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>__PAGE_TITLE__</title>
    <meta name="description" content="__PAGE_DESCRIPTION__">
    <link rel="icon" id="page-icon" href="__PAGE_ICON__">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toggle-bg:after {
            content: '';
            @apply absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform shadow-sm;
        }

        input:checked+.toggle-bg:after {
            @apply transform translate-x-full;
        }

        input:checked+.toggle-bg {
            @apply bg-sky-500;
        }
    </style>
</head>

<body class="text-white">
    <div class="fixed top-4 right-4 z-50">
        <button id="settings-button" class="w-12 h-12 bg-zinc-800/80 backdrop-blur-sm rounded-full flex items-center justify-center text-xl hover:bg-zinc-700 transition-colors shadow-lg border border-zinc-700">
            <i class="fa-solid fa-gear"></i>
        </button>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-40 flex items-center justify-center">
        <div class="bg-zinc-900 border border-zinc-700 rounded-2xl shadow-2xl p-8 w-full max-w-md m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">TTS Settings</h2>
                <button id="close-settings-button" class="text-zinc-400 hover:text-white">&times;</button>
            </div>

            <div class="space-y-6">
                <div>
                    <label for="tts-enabled" class="flex items-center justify-between cursor-pointer">
                        <span class="font-semibold text-lg">Enable TTS</span>
                        <div class="relative">
                            <input type="checkbox" id="tts-enabled" class="sr-only">
                            <div class="w-11 h-6 bg-zinc-700 rounded-full toggle-bg"></div>
                        </div>
                    </label>
                </div>

                <div id="tts-options" class="space-y-4 border-t border-zinc-700 pt-6">
                    <div>
                        <label for="api-key" class="block text-sm font-medium text-zinc-300 mb-1">ElevenLabs API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your API Key" class="w-full bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="voice-id" class="block text-sm font-medium text-zinc-300 mb-1">Voice ID</label>
                        <input type="text" id="voice-id" placeholder="Enter Voice ID (e.g., pMsXgVXv3BLzUgSXRplE)" class="w-full bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>

                    <div class="pt-4">
                        <h3 class="font-semibold mb-2">Announce Events</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-event="comment" class="event-toggle accent-sky-500"> Comments</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-event="like" class="event-toggle accent-sky-500"> Likes</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-event="follow" class="event-toggle accent-sky-500"> Follows</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-event="share" class="event-toggle accent-sky-500"> Shares</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-event="join" class="event-toggle accent-sky-500"> Joins</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-event="gift" class="event-toggle accent-sky-500"> Gifts</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-4 left-4 w-96 space-y-3">
        <div id="tts-status" class="hidden bg-zinc-900/80 backdrop-blur-md border border-zinc-700 rounded-lg p-3 shadow-lg">
            <p class="text-xs text-zinc-400 mb-1">TTS Playback</p>
            <p id="tts-current" class="text-sm truncate">Now Playing: None</p>
            <p id="tts-queue-count" class="text-xs text-zinc-500">Queue: 0</p>
        </div>

        <div id="events-container" class="space-y-3 h-96 overflow-y-auto pr-2"></div>
    </div>

    <script>
        class TTSPlayer {
            constructor() {
                this.audioQueue = [];
                this.isPlaying = false;
                this.settings = this.loadSettings();
                this.dom = {
                    status: document.getElementById('tts-status'),
                    current: document.getElementById('tts-current'),
                    queueCount: document.getElementById('tts-queue-count')
                };
            }

            loadSettings() {
                const defaults = {
                    enabled: false,
                    apiKey: '',
                    voiceId: '21m00Tcm4TlvDq8ikWAM',
                    events: {
                        comment: true,
                        like: false,
                        follow: true,
                        share: true,
                        join: false,
                        gift: true
                    }
                };
                const saved = JSON.parse(localStorage.getItem('ttsSettings'));
                return { ...defaults,
                    ...saved
                };
            }

            saveSettings(newSettings) {
                this.settings = { ...this.settings,
                    ...newSettings
                };
                localStorage.setItem('ttsSettings', JSON.stringify(this.settings));
            }

            queue(text, type) {
                if (!this.settings.enabled || !this.settings.events[type] || !this.settings.apiKey || !this.settings.voiceId) {
                    return;
                }
                this.audioQueue.push({
                    text
                });
                this.updateStatus();
                if (!this.isPlaying) {
                    this.playNext();
                }
            }

            async playNext() {
                if (this.audioQueue.length === 0) {
                    this.isPlaying = false;
                    this.updateStatus(true);
                    return;
                }

                this.isPlaying = true;
                const {
                    text
                } = this.audioQueue.shift();
                this.dom.current.textContent = `Now Playing: ${text}`;
                this.updateStatus();

                try {
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${this.settings.voiceId}`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'audio/mpeg',
                            'Content-Type': 'application/json',
                            'xi-api-key': this.settings.apiKey
                        },
                        body: JSON.stringify({
                            text: text,
                            model_id: 'eleven_multilingual_v2',
                            voice_settings: {
                                stability: 0.5,
                                similarity_boost: 0.75
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        this.playNext();
                    };
                } catch (error) {
                    console.error('TTS Error:', error);
                    this.dom.current.textContent = `Error: Could not play audio.`;
                    setTimeout(() => this.playNext(), 1000);
                }
            }

            updateStatus(finished = false) {
                if (finished && this.audioQueue.length === 0) {
                    this.dom.status.classList.add('hidden');
                    return;
                }
                this.dom.status.classList.remove('hidden');
                if (this.audioQueue.length === 0 && !this.isPlaying) {
                     this.dom.current.textContent = `Now Playing: None`;
                }
                this.dom.queueCount.textContent = `Queue: ${this.audioQueue.length}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const username = window.location.pathname.substring(1);
            if (!username) {
                window.location.href = '/';
                return;
            }

            const ttsPlayer = new TTSPlayer();
            const eventsContainer = document.getElementById('events-container');

            const createEventElement = (icon, color, user, message) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = `fade-in bg-zinc-900/80 backdrop-blur-md border-l-4 ${color} rounded-r-lg p-3 shadow-lg flex items-center gap-3`;
                eventDiv.innerHTML = `
                    <i class="fa-solid ${icon} text-lg w-6 text-center"></i>
                    <div>
                        <p class="font-bold text-sm">${user}</p>
                        <p class="text-zinc-300 text-sm">${message}</p>
                    </div>`;
                eventsContainer.appendChild(eventDiv);
                eventsContainer.scrollTop = eventsContainer.scrollHeight;
                 if (eventsContainer.children.length > 50) {
                    eventsContainer.removeChild(eventsContainer.firstChild);
                }
            };

            const connect = () => {
                const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                const ws = new WebSocket(`${protocol}://${window.location.host}/ws/${username}`);

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'system_status':
                             createEventElement('fa-circle-info', 'border-sky-500', 'System', data.status);
                            break;
                        case 'comment':
                             createEventElement('fa-comment', 'border-zinc-500', data.user, data.comment);
                            ttsPlayer.queue(`${data.user} said ${data.comment}`, 'comment');
                            break;
                        case 'like':
                             createEventElement('fa-heart', 'border-pink-500', data.user, `sent ${data.count} like${data.count > 1 ? 's' : ''}`);
                            ttsPlayer.queue(`${data.user} sent ${data.count} likes`, 'like');
                            break;
                        case 'follow':
                             createEventElement('fa-user-plus', 'border-blue-500', data.user, `followed the host`);
                            ttsPlayer.queue(`${data.user} followed`, 'follow');
                            break;
                        case 'share':
                            createEventElement('fa-share', 'border-teal-500', data.user, `shared the stream`);
                            ttsPlayer.queue(`${data.user} shared`, 'share');
                            break;
                        case 'join':
                            createEventElement('fa-person-walking-arrow-right', 'border-purple-500', data.user, `joined the stream`);
                             ttsPlayer.queue(`${data.user} joined`, 'join');
                            break;
                        case 'gift':
                            createEventElement('fa-gift', 'border-yellow-400', data.user, `sent ${data.count}x ${data.gift_name}`);
                            ttsPlayer.queue(`${data.user} sent ${data.count} ${data.gift_name}`, 'gift');
                            break;
                    }
                };

                ws.onclose = () => {
                    createEventElement('fa-triangle-exclamation', 'border-red-500', 'System', 'Connection lost. Reconnecting in 5 seconds...');
                    setTimeout(connect, 5000);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    ws.close();
                };
            };

            const settingsButton = document.getElementById('settings-button');
            const closeSettingsButton = document.getElementById('close-settings-button');
            const settingsModal = document.getElementById('settings-modal');
            const ttsOptions = document.getElementById('tts-options');
            const ttsEnabledToggle = document.getElementById('tts-enabled');
            const apiKeyInput = document.getElementById('api-key');
            const voiceIdInput = document.getElementById('voice-id');
            const eventToggles = document.querySelectorAll('.event-toggle');

            const updateSettingsUI = () => {
                const settings = ttsPlayer.settings;
                ttsEnabledToggle.checked = settings.enabled;
                apiKeyInput.value = settings.apiKey;
                voiceIdInput.value = settings.voiceId;
                ttsOptions.style.display = settings.enabled ? 'block' : 'none';
                eventToggles.forEach(toggle => {
                    toggle.checked = settings.events[toggle.dataset.event] || false;
                });
            };

            settingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettingsButton.addEventListener('click', () => settingsModal.classList.add('hidden'));

            ttsEnabledToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                ttsOptions.style.display = isEnabled ? 'block' : 'none';
                ttsPlayer.saveSettings({ enabled: isEnabled });
            });
            
            apiKeyInput.addEventListener('change', (e) => ttsPlayer.saveSettings({ apiKey: e.target.value }));
            voiceIdInput.addEventListener('change', (e) => ttsPlayer.saveSettings({ voiceId: e.target.value }));

            eventToggles.forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const newEventSettings = { ...ttsPlayer.settings.events, [e.target.dataset.event]: e.target.checked };
                    ttsPlayer.saveSettings({ events: newEventSettings });
                });
            });
            
            updateSettingsUI();
            connect();
        });
    </script>
</body>

</html>
